name: Nightly Tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full

jobs:
  comprehensive-tests:
    name: Comprehensive Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    services:
      reductstore:
        image: reduct/store:latest
        env:
          RS_LOG_LEVEL: INFO
          RS_DATA_PATH: /data
          RS_API_BASE_PATH: /
        ports:
          - 28383:8383
        options: >-
          --health-cmd="curl -f http://localhost:8383/api/v1/info || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      
      zenoh:
        image: eclipse/zenoh:latest
        ports:
          - 27447:7447
        options: >-
          --health-cmd="zenoh-plugin-rest info || exit 0"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Protocol Buffers compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for ReductStore..."
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:28383/api/v1/info > /dev/null 2>&1; then
              echo "ReductStore ready"
              break
            fi
            sleep 2
          done
          echo "Waiting for Zenoh..."
          for i in {1..30}; do
            if nc -z 127.0.0.1 27447 > /dev/null 2>&1; then
              echo "Zenoh ready"
              break
            fi
            sleep 2
          done
      
      - name: Run all tests with coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
        env:
          REDUCTSTORE_TEST_URL: http://127.0.0.1:28383
          ZENOH_TEST_ENDPOINT: tcp/127.0.0.1:27447
      
      - name: Generate HTML coverage report
        run: cargo llvm-cov --all-features --workspace --html
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/llvm-cov/html/
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          flags: nightly
      
      - name: Run benchmarks (if any)
        run: cargo bench --no-run || true
      
      - name: Check for memory leaks (Valgrind)
        run: |
          sudo apt-get update && sudo apt-get install -y valgrind
          cargo build --tests
          # Run a simple test with valgrind
          valgrind --leak-check=full --error-exitcode=1 \
            target/debug/deps/protocol_tests-* || true
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Nightly tests failed. Check logs for details."

  long-running-tests:
    name: Long Running Tests
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    services:
      reductstore:
        image: reduct/store:latest
        env:
          RS_LOG_LEVEL: INFO
          RS_DATA_PATH: /data
          RS_API_BASE_PATH: /
        ports:
          - 28383:8383
        options: >-
          --health-cmd="curl -f http://localhost:8383/api/v1/info || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      
      zenoh:
        image: eclipse/zenoh:latest
        ports:
          - 27447:7447
        options: >-
          --health-cmd="zenoh-plugin-rest info || exit 0"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Protocol Buffers compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for ReductStore..."
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:28383/api/v1/info > /dev/null 2>&1; then
              echo "ReductStore ready"
              break
            fi
            sleep 2
          done
          echo "Waiting for Zenoh..."
          for i in {1..30}; do
            if nc -z 127.0.0.1 27447 > /dev/null 2>&1; then
              echo "Zenoh ready"
              break
            fi
            sleep 2
          done
      
      - name: Run tests with stress testing
        run: |
          # Run tests multiple times to catch race conditions
          for i in {1..5}; do
            echo "Test iteration $i"
            cargo test --all-features --workspace -- --test-threads=1 || exit 1
          done
        env:
          REDUCTSTORE_TEST_URL: http://127.0.0.1:28383
          ZENOH_TEST_ENDPOINT: tcp/127.0.0.1:27447

